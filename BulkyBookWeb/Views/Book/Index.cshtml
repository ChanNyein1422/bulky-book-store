@{
    var result = User.Identity.IsAuthenticated.ToString();
    var _userid = 0;
    var _role = "User";
    if (result == "True")
    {
        _userid = Convert.ToInt32(User.Claims.ToArray()[BulkyBookWeb.AuthServices.Auth.AuthDataIndex.Id].Value);
        _role = User.Claims.ToArray()[BulkyBookWeb.AuthServices.Auth.AuthDataIndex.Role].Value;
    }
}
<h3>Explore Our Books</h3>
<div class="ms-2">
    @if (_role == "Admin")
    {
        <button type="button" class="btn btn-light border-dark my-3" onclick="load_addform()">
            + Upload Book
        </button>

        <div class="modal fade" id="addBookModal" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div id="formholder"></div>
                </div>

            </div>
        </div>
    }

    <div id="loading">
        <div class="spinner-border" role="status"></div>
        <span class="h3 ms-3"> Loading Books. Please Wait....</span>
    </div>
    <div id="bookView">

    </div>
</div>


@section scripts{
    <script>
        "use strict";
        var shoppingCart = [];
        $(function () {
            get_book();
           
        });

        function get_book() {
            $.ajax({
                cache: false,
                url: '@Url.Action("_BookList","Book")',
                success: function (result) {
                    $("#loading").empty();
                    $("#bookView").empty().append(result);

                    loaddisplayselected();
                }
            });
        }

        function delete_book(id){
            $.ajax({
                cache: false,
                url: '@Url.Action("DeleteBook", "Book")',
                data: {id : id},
                success: function(response){
                    if (response == "Success"){
                        alert("Book Deleted");
                    }else{
                        alert("Delete Fail");
                    }
                },
                complete: function(){
                    get_book();
                }
            });
        }

        function load_category(){
            $.ajax({
                cache: false,
                url: '@Url.Action("CategoryList","Category")',
                beforeSend: function(){
                },
                success: function(response){
                    $('#category_select').empty();
                    $('#category_select').append("<option value='0'>Select Category</option>");
                    for(var i = 0; i < response.length; i++){
                        $('#category_select').append(`<option value='${response[i].Id}'>${response[i].Category}</option>`);

                    }
                }
            });
        }

        function load_addform() {
      
            popup_modalform('#addBookModal', '#formholder', '@Url.Action("_AddBook","Book")', form_submit);
        }

        function popup_modalform(modal, formholder, url, callback) {
            $.ajax({
                cache: false,
                url: url,
                beforeSend: function () {
                    showmodal(modal)
                },
                success: function (result) {
                    $(formholder).empty().append(result);
                     load_category();
                    callback();
                },
                complete: function () {
                }
            });
        }
        function FileOnChange() {
          
            $('#upload').change(function () {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $("#bookUpload").val(e.target.result.split(",")[1]);
                    
                }
                reader.readAsDataURL(this.files[0]);

            });

            $('#thumbnail').change(function () {
                var input = this;
                var url = $(this).val();
                var ext = url.substring(url.lastIndexOf('.') + 1).toLowerCase();

                const QUALITY = 0.5;

                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                const imageInput = document.getElementById('thumbnail');

                const file = this.files[0];
                var reader = new FileReader();

                reader.onload = function (e) {
                    const img = new Image();
                    img.addEventListener('load', function () {
                        let width = img.width;
                        let height = img.height;


                        canvas.width = width;
                        canvas.height = height;

                        // Draw image on canvas with resized dimensions
                        ctx.drawImage(img, 0, 0, width, height);


                        // Get resized image data as a base64 encoded JPEG
                        //const resizedImage = canvas.toDataURL('image/jpeg');
                        //console.log(resizedImage);
                        canvas.toBlob(function (blob) {
                            console.log(file.name, " ", file.type);
                            const compressedFile = new File([blob], file.name, { type: file.type });
                            console.log("Blob : ", blob);
                            const finalcompressed = canvas.toDataURL('image/jpeg', 50 / 100);
                            console.log(finalcompressed);
                            $("#thumbnailUpload").val(finalcompressed.split(",")[1]);
                        }, file.type, QUALITY);
                    });
                    img.src = this.result;
                }
                reader.readAsDataURL(file);

            });
        }

        function form_submit() {
            FileOnChange();
            $('#addForm').submit(function (e) {
                e.preventDefault();

                $.ajax({
                    cache: false,
                    url: '@Url.Action("UpSert","Book")',
                    type: "Post",
                    data: $(this).serialize(),
                    beforeSend: function () {
                        $('.btn').prop("disabled", true);
                    },
                    success: function (myData) {
                        alert("New Book Added! ");
                        get_book();
                    },
                    complete: function () {
                        hidemodal("#addBookModal");
                        $('.btn').prop("disabled", false);
                    }
                });

            });
        }

        function showmodal(div) {
            $(div).modal('show');
        }

        function hidemodal(div) {
            $(div).modal('hide');
        }

        function add_to_cart(bookid, bookname, price){

            var remove_button = `<a class="btn btn-danger ms-2" onclick="remove_from_cart('${bookid}', '${bookname}', '${price}')">Remove</a>`;
            var obj = {
                "bookid": bookid,
                "bookname": bookname,
                "price": price
            };

            shoppingCart.push(obj);
            localStorage.setItem("shoppingCart", JSON.stringify(shoppingCart));
            $("#shop_"+bookid).empty().append(remove_button);

        }
        function remove_from_cart(bookid, bookname, price){

            var add_button = `<a class="btn btn-success ms-2" onclick="add_to_cart('${bookid}', '${bookname}', '${price}')">
                                                    <i class="fa-solid fa-cart-shopping me-2"></i>
                                                </a>`;
            var localDatas = localStorage.getItem("shoppingCart");
            shoppingCart = JSON.parse(localDatas);

            shoppingCart = shoppingCart.filter(function (el) { return el.bookid != bookid; });
            localStorage.setItem("shoppingCart", JSON.stringify(shoppingCart));
            $("#shop_" + bookid).empty().append(add_button);

        }


        function loaddisplayselected(){
            var localDatas = localStorage.getItem("shoppingCart");
            if(localDatas != null){
                shoppingCart = JSON.parse(localDatas);
                if (shoppingCart.length > 0) {
                    for (var i in shoppingCart) {
                        var remove_button = `<a class="btn btn-danger ms-2" onclick="remove_from_cart('${shoppingCart[i].bookid}', '${shoppingCart[i].bookname} ', '${shoppingCart[i].price} ')">Remove</a>`;
                        $('#shop_' + shoppingCart[i].bookid).empty().append(remove_button)
                    }
                }
            }
         
        }

    </script>
}